{
  "Name": "Export SharePoint Permissions to CSV (including lists and libraries)",
  "CreationDate": "2024-10-17",
  "Commands": [
    {
      "Command": "store",
      "Target": "eval|Date.now()",
      "Value": "timestamp",
      "Comment": "Generate a timestamp for the filename"
    },
    {
      "Command": "click",
      "Target": "xpath=//*[@id='O365_MainLink_Settings']",
      "Comment": "Click the Settings gear icon"
    },
    {
      "Command": "click",
      "Target": "xpath=//*[contains(text(), 'Site contents')]",
      "Comment": "Open Site contents"
    },
    {
      "Command": "storeText",
      "Target": "css=#DeltaPlaceHolderPageTitleInTitleArea",
      "Value": "siteName",
      "Comment": "Store the site name for the filename"
    },
    {
      "Command": "executeScript",
      "Target": "let csvData = 'Item,Type,User/Group,Permission\\n'; const items = Array.from(document.querySelectorAll('.ms-List-cell')); for (let item of items) { const name = item.querySelector('.ms-List-itemName').textContent.trim(); const type = item.querySelector('.ms-List-itemMeta').textContent.trim(); csvData += `${name},${type},,\\n`; } return csvData;",
      "Value": "csvData",
      "Comment": "Extract list of all items (lists and libraries) from Site contents"
    },
    {
      "Command": "executeScript",
      "Target": "const items = Array.from(document.querySelectorAll('.ms-List-cell')); if (items.length > 0) { items[0].querySelector('button[name=\"IconButton\"]').click(); return 'clicked'; } return 'no items';",
      "Value": "clickResult",
      "Comment": "Click on the first item's menu"
    },
    {
      "Command": "click",
      "Target": "xpath=//*[contains(text(), 'Settings')]",
      "Comment": "Click on Settings in the item's menu"
    },
    {
      "Command": "click",
      "Target": "xpath=//*[contains(text(), 'Permissions for this')]",
      "Comment": "Click on 'Permissions for this list' or 'Permissions for this document library'"
    },
    {
      "Command": "executeScript",
      "Target": "const table = document.querySelector('#onetidPermissionsTable'); if (!table) return ${csvData}; const rows = Array.from(table.querySelectorAll('tr')); const itemName = document.querySelector('#pageTitle').textContent.trim(); for (let row of rows) { const cells = Array.from(row.querySelectorAll('td')); if (cells.length < 3) continue; const name = cells[0].textContent.trim(); const type = cells[1].textContent.trim(); const permission = cells[2].textContent.trim(); csvData += `${itemName},${type},${name},${permission}\\n`; } return csvData;",
      "Value": "csvData",
      "Comment": "Extract permissions for the current item and add to CSV data"
    },
    {
      "Command": "executeScript",
      "Target": "history.back(); history.back();",
      "Comment": "Go back to Site contents page"
    },
    {
      "Command": "pause",
      "Target": "2000",
      "Comment": "Wait for page to load"
    },
    {
      "Command": "executeScript",
      "Target": "const blob = new Blob([`${csvData}`], {type: 'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${storedVars.siteName}_permissions_${storedVars.timestamp}.csv`; a.click(); URL.revokeObjectURL(a.href);",
      "Comment": "Create and download the CSV file"
    },
    {
      "Command": "echo",
      "Target": "Permissions exported to CSV: ${siteName}_permissions_${timestamp}.csv",
      "Comment": "Display confirmation message"
    }
  ]
}
